# Діаграми системи HiveMind Mesh

## 1. Component Diagram (Діаграма компонентів)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Communication Control API                       │
│                         (Порт 8080)                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐   │
│  │ HiveController   │    │ ClientController │    │HiveMindMesh      │   │
│  │                  │    │                  │    │IntegrationCtrl   │   │
│  │ • Connect        │    │ • GetArea        │    │                  │   │
│  │ • Telemetry      │    │ • GetHives       │    │ • Proxy endpoints│   │
│  └────────┬─────────┘    │ • Interferences  │    │ • Batch ops      │   │
│           │              └────────┬─────────┘    └────────┬─────────┘   │
│           │                       │                       │             │
│           └───────────────────────┴───────────────────────┘             │
│                                    │                                    │
│                          ┌─────────▼─────────┐                          │
│                          │Communication      │                          │
│                          │ControlService     │                          │
│                          └─────────┬─────────┘                          │
│                                    │                                    │
│                          ┌─────────▼─────────┐                          │
│                          │  Redis Client     │                          │
│                          │  (Message Bus)    │                          │
│                          └───────────────────┘                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTP Proxy
                                    │
┌───────────────────────────────────▼───────────────────────────────────┐
│                         HiveMind API                                  │
│                         (Порт 5149)                                   │
├───────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │                    Minimal API Endpoints                        │  │
│  │  • Drones (8 endpoints)                                         │  │
│  │  • Hives (10 endpoints)                                         │  │
│  │  • Commands (3 endpoints)                                       │  │
│  │  • Topology (3 endpoints)                                       │  │
│  │  • Connections (2 endpoints)                                    │  │
│  │  • Health (1 endpoint)                                          │  │
│  └────────────────────────┬────────────────────────────────────────┘  │
│                           │                                           │
│  ┌────────────────────────▼────────────────────────────────────────┐  │
│  │                    Services Layer                               │  │
│  │                                                                 │  │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────┐   │  │
│  │  │DroneRelayService │  │DroneCommand      │  │HiveMind      │   │  │
│  │  │                  │  │Service           │  │Service       │   │  │
│  │  │• GetSwarm        │  │• SendCommand     │  │• ConnectHive │   │  │
│  │  │• BatchCreate     │  │• GetCommands     │  │• Telemetry   │   │  │
│  │  │• RebuildTopology │  │• JoinDrone       │  │• UpdateId    │   │  │
│  │  │• DegradeConn     │  │• BatchJoin       │  │              │   │  │
│  │  └────────┬─────────┘  └────────┬─────────┘  └───────┬──────┘   │  │
│  │           │                     │                    │          │  │
│  │           └─────────────────────┴────────────────────┘          │  │
│  │                           │                                     │  │
│  └───────────────────────────┼─────────────────────────────────────┘  │
│                              │                                        │
│  ┌───────────────────────────▼─────────────────────────────────────┐  │
│  │                    Domain Layer                                 │  │
│  │                                                                 │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │  │
│  │  │Topology      │  │Connectivity  │  │MeshRouting           │   │  │
│  │  │Builder       │  │Analyzer      │  │Service               │   │  │
│  │  │              │  │              │  │                      │   │  │
│  │  │• BuildMesh   │  │• Analyze     │  │• RouteCommand        │   │  │
│  │  │• BuildStar   │  │  Connection  │  │• FindShortestPath    │   │  │
│  │  │• BuildDual   │  │• Analyze     │  │                      │   │  │
│  │  │  Star        │  │  Swarm       │  │                      │   │  │
│  │  └──────┬───────┘  └───────┬──────┘  └────────────┬─────────┘   │  │
│  │         │                  │                      │             │  │
│  │  ┌──────▼──────────────────▼──────────────────────▼──────────┐  │  │
│  │  │              ConnectionManager                            │  │  │
│  │  │              • UpdateWeight                               │  │  │
│  │  │              • RemoveConnection                           │  │  │
│  │  └───────────────────────┬───────────────────────────────────┘  │  │
│  │                          │                                      │  │
│  │  ┌───────────────────────▼─────────────────────────────────┐    │  │
│  │  │                    Repositories                         │    │  │
│  │  │                                                         │    │  │
│  │  │  ┌─────────────┐              ┌──────────────┐          │    │  │
│  │  │  │Drone        │              │Hive          │          │    │  │
│  │  │  │Repository   │              │Repository    │          │    │  │
│  │  │  │             │              │              │          │    │  │
│  │  │  │• Add        │              │• Create      │          │    │  │
│  │  │  │• Update     │              │• Get         │          │    │  │
│  │  │  │• Remove     │              │• Delete      │          │    │  │
│  │  │  │• GetAll     │              │• AddDrone    │          │    │  │
│  │  │  └──────┬──────┘              └──────┬───────┘          │    │  │
│  │  │         │                            │                  │    │  │
│  │  └─────────┼────────────────────────────┼──────────────────┘    │  │
│  │            │                            │                       │  │
│  └────────────┼────────────────────────────┼───────────────────────┘  │
│               │                            │                          │
│  ┌────────────▼────────────────────────────▼───────────────────┐      │
│  │              HiveInMemoryState                              │      │
│  │              (In-Memory Storage)                            │      │
│  │                                                             │      │
│  │  • _drones: Dictionary<string, Drone>                       │      │
│  │  • _hives: Dictionary<string, Hive>                         │      │
│  │  • _hiveDrones: Dictionary<string, HashSet<string>>         │      │
│  │  • _droneCommands: Dictionary<string, Queue<DroneCommand>>  │      │
│  │  • _hiveTelemetry: Dictionary<string, HiveTelemetryData>    │      │
│  │  • _hiveEntryRelays: Dictionary<string, HashSet<string>>    │      │
│  └─────────────────────────────────────────────────────────────┘      │
└───────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTP
                                    │
┌───────────────────────────────────▼───────────────────────────────────┐
│                         External Services                             │
│                                                                       │
│  ┌──────────────────────────┐    ┌──────────────────────────┐         │
│  │         Redis            │    │      Map Client          │         │
│  │        (6379)            │    │       (3000)             │         │
│  │                          │    │                          │         │
│  │      Message Bus         │    │      React App           │         │
│  └──────────────────────────┘    └──────────────────────────┘         │
└───────────────────────────────────────────────────────────────────────┘
```

## 2. Sequence Diagram (Діаграма послідовності)

### 2.1. Створення рою та побудова топології

```
Користувач    Communication Control    HiveMind API    DroneRelayService    TopologyBuilder    HiveInMemoryState
     │                  │                      │                │                    │                    │
     │ POST /hivemind/  │                      │                │                    │                    │
     │ hives            │                      │                │                    │                    │
     ├─────────────────►│                      │                │                    │                    │
     │                  │ POST /api/v1/hives   │                │                    │                    │
     │                  ├─────────────────────►│                │                    │                    │
     │                  │                      │ CreateHive()   │                    │                    │
     │                  │                      ├───────────────►│                    │                    │
     │                  │                      │                │                    │  AddHive(hive)     │
     │                  │                      │                │                    ├───────────────────►│
     │                  │                      │                │                    │                    │
     │                  │                      │◄───────────────┤                    │                    │
     │                  │◄─────────────────────┤                │                    │                    │
     │◄─────────────────┤                      │                │                    │                    │
     │                  │                      │                │                    │                    │
     │ POST /hivemind/  │                      │                │                    │                    │
     │ drones/batch     │                      │                │                    │                    │
     ├─────────────────►│                      │                │                    │                    │
     │                  │ POST /api/v1/drones/ │                │                    │                    │
     │                  │ batch                │                │                    │                    │
     │                  ├─────────────────────►│                │                    │                    │
     │                  │                      │ BatchCreate()  │                    │                    │
     │                  │                      ├───────────────►│                    │                    │
     │                  │                      │                │                    │  UpsertDrone()     │
     │                  │                      │                │                    ├───────────────────►│
     │                  │                      │                │                    │                    │
     │                  │                      │◄───────────────┤                    │                    │
     │                  │◄─────────────────────┤                │                    │                    │
     │◄─────────────────┤                      │                │                    │                    │
     │                  │                      │                │                    │                    │
     │ POST /hivemind/  │                      │                │                    │                    │
     │ hives/{id}/      │                      │                │                    │                    │
     │ drones/batch-join│                      │                │                    │                    │
     ├─────────────────►│                      │                │                    │                    │
     │                  │ POST /api/v1/hives/  │                │                    │                    │
     │                  │ {id}/drones/         │                │                    │                    │
     │                  │ batch-join           │                │                    │                    │
     │                  ├─────────────────────►│                │                    │                    │
     │                  │                      │ BatchJoin()    │                    │                    │
     │                  │                      ├───────────────►│                    │                    │
     │                  │                      │                │                    │  AddDroneToHive()  │
     │                  │                      │                │                    ├───────────────────►│
     │                  │                      │                │                    │                    │
     │                  │                      │◄───────────────┤                    │                    │
     │                  │◄─────────────────────┤                │                    │                    │
     │◄─────────────────┤                      │                │                    │                    │
     │                  │                      │                │                    │                    │
     │ POST /hivemind/  │                      │                │                    │                    │
     │ hives/{id}/      │                      │                │                    │                    │
     │ topology/rebuild │                      │                │                    │                    │
     ├─────────────────►│                      │                │                    │                    │
     │                  │ POST /api/v1/hives/  │                │                    │                    │
     │                  │ {id}/topology/rebuild│                │                    │                    │
     │                  ├─────────────────────►│                │                    │                    │
     │                  │                      │ RebuildTopology│                    │                    │
     │                  │                      ├───────────────►│                    │                    │
     │                  │                      │                │ RemoveAllConn()    │                    │
     │                  │                      │                ├───────────────────►│                    │
     │                  │                      │                │                    │                    │
     │                  │                      │                │ BuildMeshTopology  │                    │
     │                  │                      │                ├───────────────────►│                    │
     │                  │                      │                │                    │  Update(drone)     │
     │                  │                      │                │                    ├───────────────────►│
     │                  │                      │                │                    │                    │
     │                  │                      │◄───────────────┤                    │                    │
     │                  │◄─────────────────────┤                │                    │                    │
     │◄─────────────────┤                      │                │                    │                    │
```

### 2.2. Відправка команди через mesh-мережу

```
Користувач    HiveMind API    DroneRelayService    MeshRoutingService    ConnectivityAnalyzer    HiveInMemoryState
     │              │                  │                    │                        │                    │
     │ POST /hives/ │                  │                    │                        │                    │
     │ {id}/drones/ │                  │                    │                        │                    │
     │ {droneId}/   │                  │                    │                        │                    │
     │ commands/mesh│                  │                    │                        │                    │
     ├─────────────►│                  │                    │                        │                    │
     │              │ SendCommandVia   │                    │                        │                    │
     │              │ Mesh()           │                    │                        │                    │
     │              ├─────────────────►│                    │                        │                    │
     │              │                  │ RouteCommand()     │                        │                    │
     │              │                  ├───────────────────►│                        │                    │
     │              │                  │                    │ AnalyzeConnection()    │                    │
     │              │                  │                    ├───────────────────────►│                    │
     │              │                  │                    │                        │ GetEntryRelays()   │
     │              │                  │                    │                        ├───────────────────►│
     │              │                  │                    │                        │                    │
     │              │                  │                    │                        │◄───────────────────┤
     │              │                  │                    │                        │                    │
     │              │                  │                    │                        │ FindShortestPath() │
     │              │                  │                    │                        │ (BFS algorithm)    │
     │              │                  │                    │                        ├───────────────────►│
     │              │                  │                    │                        │                    │
     │              │                  │                    │◄───────────────────────┤                    │
     │              │                  │                    │ Path found             │                    │
     │              │                  │                    │                        │                    │
     │              │                  │                    │ SendViaRelays()        │                    │
     │              │                  │                    ├────────────────────────┼───────────────────►│
     │              │                  │                    │                        │ AddDroneCommand()  │
     │              │                  │                    │                        │ (for each relay)   │
     │              │                  │                    │                        │                    │
     │              │                  │◄───────────────────┤                        │                    │
     │              │                  │ MeshCommandResponse│                        │                    │
     │              │◄─────────────────┤                    │                        │                    │
     │◄─────────────┤                  │                    │                        │                    │
     │              │                  │                    │                        │                    │
```

### 2.3. Аналіз зв'язності рою

```
Користувач    HiveMind API    DroneRelayService    ConnectivityAnalyzer    HiveInMemoryState
     │              │                  │                        │                    │
     │ GET /hives/  │                  │                        │                    │
     │ {id}/topology│                  │                        │                    │
     │ /connectivity│                  │                        │                    │
     ├─────────────►│                  │                        │                    │
     │              │ AnalyzeSwarm     │                        │                    │
     │              │ Connectivity()   │                        │                    │
     │              ├─────────────────►│                        │                    │
     │              │                  │ AnalyzeSwarm           │                    │
     │              │                  │ Connectivity()         │                    │
     │              │                  ├───────────────────────►│                    │
     │              │                  │                        │ GetDroneIds()      │
     │              │                  │                        ├───────────────────►│
     │              │                  │                        │                    │
     │              │                  │                        │◄───────────────────┤
     │              │                  │                        │                    │
     │              │                  │                        │ FindConnected      │
     │              │                  │                        │ Components()       │
     │              │                  │                        │ (BFS algorithm)    │
     │              │                  │                        ├───────────────────►│
     │              │                  │                        │                    │
     │              │                  │                        │◄───────────────────┤
     │              │                  │                        │ Components found   │
     │              │                  │                        │                    │
     │              │                  │                        │ CountConnections() │
     │              │                  │                        │ BuildGraph()       │
     │              │                  │                        ├───────────────────►│
     │              │                  │                        │                    │
     │              │                  │◄───────────────────────┤                    │
     │              │                  │ SwarmConnectivity      │                    │
     │              │                  │ Response               │                    │
     │              │◄─────────────────┤                        │                    │
     │◄─────────────┤                  │                        │                    │
     │              │                  │                        │                    │
```

## 3. Загальна архітектура системи

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Користувач / API Client                         │
└───────────────────────────────┬─────────────────────────────────────────┘
                                 │
                                 │ HTTP REST API
                                 │
        ┌────────────────────────┴────────────────────────┐
        │                                                 │
        ▼                                                 ▼
┌───────────────────────┐                    ┌───────────────────────┐
│ Communication Control │                    │    HiveMind API       │
│      API (8080)       │◄──────────────────►│      (5149)           │
│                       │    HTTP Proxy      │                       │
│ • Центральний         │    Requests        │ • Управління роєм     │
│   контролер           │                    │ • Топології           │
│ • Проксі до HiveMind  │                    │ • Mesh-маршрутизація  │
│ • Телеметрія          │                    │ • In-Memory State     │
│ • Логування           │                    │                       │
└───────────┬───────────┘                    └───────────────────────┘
            │
            │ HTTP
            │
            ▼
    ┌───────────────┐
    │    Redis      │
    │  (6379)       │
    │               │
    │ Message Bus   │
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐
    │  Map Client   │
    │   (3000)      │
    │               │
    │  React App    │
    └───────────────┘
```
